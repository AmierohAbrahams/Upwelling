---
title: "Exploring_data"
author: "Amieroh Abrahams"
date: "16 May 2019"
output: html_document
---

# Some questions:
  # What is the climatological baseline
  # Calculate upwelling for all the years ad then it a linear regression to find a trend
  # How am I spacially going to define upwelling
  # Run this on each pixel individually 
  # How will I combine the results for each EBUS to quntify the changes in upwelling

# Adding column names
```{r}
BC <- read_csv("/home/amieroh/Documents/spatial/data/csv/BC-avhrr-only-v2.Document-Document.csv", col_names = c("lon", "lat", "temp", "t"))
CalC <- read_csv("/home/amieroh/Documents/spatial/data/csv/CalC-avhrr-only-v2.Document-Document.csv", col_names = c("lon", "lat", "temp", "t"))
CC <- read_csv("/home/amieroh/Documents/spatial/data/csv/CC-avhrr-only-v2.Document-Document.csv", col_names = c("lon", "lat", "temp", "t"))
HC <- read_csv("/home/amieroh/Documents/spatial/data/csv/CC-avhrr-only-v2.Document-Document.csv", col_names = c("lon", "lat", "temp", "t"))

```

# Monthly data from daily data

```{r}
require(fasttime)
library(plyr)
library(fasttime)

# functions.R

# a new date class
setClass('myDate')
setAs("character", "myDate", function(from) as.Date(fastPOSIXct(from, tz = NULL)))

# a fast date function
fastDate <- function(x, tz = NULL) {
  as.Date(fastPOSIXct(x, tz = tz))
}

daily2monthly <- function(dailyData) {
  monthlyData <- dailyData %>%
    plyr::mutate(t = fastDate(t)) %>%
    dplyr::mutate(month = floor_date(t, unit = "month")) %>%
    dplyr::group_by(lon, lat, month) %>%
    dplyr::summarise(temp = mean(temp, na.rm = TRUE)) %>%
    dplyr::mutate(year = year(month)) %>%
    dplyr::group_by(lon, lat) %>%
    dplyr::mutate(num = seq(1:length(temp))) %>%
    dplyr::ungroup()
  return(monthlyData)
}

BC_monthly <- daily2monthly(BC)
CalC_monthly <- daily2monthly(CalC)
CC_monthly <- daily2monthly(CC)
HC_monthly <- daily2monthly(HC)

#inDir <- "/home/amieroh/Documents/Masters_2019/Upwelling/global_EBUS/data"
outDir <- "/home/amieroh/Documents/Masters_2019/Upwelling/global_EBUS/data"
fwrite(BC_monthly,
       paste0(outDir, "/BC_monthly",
              format(as.Date(BC_monthly$month, format = "%Y%m%d"), "%Y%m%d")[1], "-",
              format(as.Date(BC_monthly$month, format = "%Y%m%d"), "%Y%m%d")[nrow(BC_monthly)], ".csv"))

fwrite(CalC_monthly,
       paste0(outDir, "/BC_monthly",
              format(as.Date(BC_monthly$month, format = "%Y%m%d"), "%Y%m%d")[1], "-",
              format(as.Date(BC_monthly$month, format = "%Y%m%d"), "%Y%m%d")[nrow(BC_monthly)], ".csv"))

# Calculating the climatology
ts2clm.grid <- function(data) {
  out <- ts2clm(data, x = t, y = temp,
                climatologyPeriod = c("1982-01-01", "2017-12-31"),
                robust = FALSE, maxPadLength = 3, windowHalfWidth = 5,
                pctile = 90, smoothPercentile = TRUE,
                smoothPercentileWidth = 31, clmOnly = FALSE)
  return(out)
}

BC_clim <- ddply(BC, .(lon, lat), ts2clm.grid,
                 .parallel = TRUE, .progress = "text")

CalC_clim <- ddply(CalC, .(lon, lat), ts2clm.grid,
                 .parallel = TRUE, .progress = "text")
```

## Seasonal climatology

```{r}
# a function to create monthly data from daily data
daily2DJF_JJA <- function(dailyData) {
  seasonData <- dailyData %>%
    dplyr::mutate(t = month(t)) %>%
    dplyr::filter(t %in% c(12, 1, 2, 6, 7, 8)) %>%
    dplyr::mutate(t = dplyr::recode_factor(t, `12` = "DJF", `1` = "DJF", `2` = "DJF",
                                           `6` = "JJA", `7` = "JJA", `8` = "JJA")) %>%
    dplyr::group_by(lon, lat, t) %>%
    dplyr::summarise(temp = mean(temp, na.rm = TRUE)) %>%
    dplyr::ungroup()
  return(seasonData)
}

BC_seas <- daily2DJF_JJA(BC)
CalC_seas <- daily2DJF_JJA(CalC)

BC_fig1 <- ggplot(BC_seas, aes(x = lon, y = lat)) +
  facet_wrap(~ t) +
  geom_raster(aes(fill = temp), interpolate = FALSE)

CalC_fig1 <- ggplot(CalC_seas, aes(x = lon, y = lat)) +
  facet_wrap(~ t) +
  geom_raster(aes(fill = temp), interpolate = FALSE)
```


































